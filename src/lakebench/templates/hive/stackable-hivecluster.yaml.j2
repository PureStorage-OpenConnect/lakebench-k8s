---
# Stackable HiveCluster - Managed Hive Metastore with S3 support
# Proven deployment pattern for S3-backed Hive Metastore
apiVersion: hive.stackable.tech/v1alpha1
kind: HiveCluster
metadata:
  name: lakebench-hive
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: lakebench
    app.kubernetes.io/instance: {{ name }}
    app.kubernetes.io/component: hive
    app.kubernetes.io/managed-by: lakebench
spec:
  image:
    productVersion: "{{ hive_version | default('3.1.3') }}"
  clusterConfig:
    database:
      dbType: postgres
      connString: jdbc:postgresql://lakebench-postgres:5432/hive?connectTimeout=30&socketTimeout=300&loginTimeout=30
      credentialsSecret: lakebench-postgres-secret
    s3:
      inline:
        host: {{ s3_host }}
        port: {{ s3_port }}
        accessStyle: "{{ 'Path' if s3_path_style else 'VirtualHosted' }}"
        credentials:
          secretClass: "lakebench-s3-credentials-class"
  metastore:
    roleGroups:
      default:
        replicas: 1
        config:
          resources:
            cpu:
              min: "{{ hive_cpu_min | default('500m') }}"
              max: "{{ hive_cpu_max | default('2') }}"
            memory:
              limit: "{{ hive_memory | default('4Gi') }}"
        configOverrides:
          hive-site.xml:
            # Connection pool settings (proven defaults)
            javax.jdo.option.ConnectionPool.maxPoolSize: "20"
            javax.jdo.option.ConnectionPool.maxActive: "15"
            javax.jdo.option.ConnectionPool.maxIdle: "5"
            javax.jdo.option.ConnectionPool.minIdle: "2"
            javax.jdo.option.ConnectionTimeout: "30000"

            # Metastore server settings
            hive.metastore.server.min.threads: "10"
            hive.metastore.server.max.threads: "50"
            hive.metastore.server.tcp.keepalive: "true"

            # Client timeout settings
            hive.metastore.client.socket.timeout: "300s"
            hive.metastore.client.connect.retry.delay: "5s"
            hive.metastore.failure.retries: "3"

            # Transaction and locking
            hive.support.concurrency: "true"
            hive.exec.dynamic.partition.mode: "nonstrict"

            # Performance optimization
            hive.metastore.cache.pinobjtypes: "Table,Database,Type,FieldSchema,Order"
            hive.metastore.batch.retrieve.max: "500"
            hive.metastore.batch.retrieve.table.partition.max: "1000"
