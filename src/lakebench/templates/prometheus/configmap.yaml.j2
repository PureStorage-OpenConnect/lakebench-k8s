{# Prometheus configuration - scrape configs for Spark and Trino #}
apiVersion: v1
kind: ConfigMap
metadata:
  name: lakebench-prometheus-config
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: lakebench
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      # Prometheus self-monitoring
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # Spark driver metrics
      # Spark UI exposes Prometheus metrics on port 4040
      - job_name: 'spark-driver'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['{{ namespace }}']
        relabel_configs:
          # Only scrape pods with spark-role=driver label (Kubeflow Spark Operator)
          - source_labels: [__meta_kubernetes_pod_label_spark_role]
            action: keep
            regex: driver
          # Rewrite target to port 4040
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: '${1}:4040'
          # Add pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          # Add app name label
          - source_labels: [__meta_kubernetes_pod_label_sparkoperator_k8s_io_app_name]
            target_label: spark_app
        metrics_path: /metrics/prometheus

      # Spark executor metrics
      - job_name: 'spark-executor'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['{{ namespace }}']
        relabel_configs:
          # Only scrape pods with spark-role=executor label
          - source_labels: [__meta_kubernetes_pod_label_spark_role]
            action: keep
            regex: executor
          # Rewrite target to port 4040
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: '${1}:4040'
          # Add pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          # Add app name label
          - source_labels: [__meta_kubernetes_pod_label_sparkoperator_k8s_io_app_name]
            target_label: spark_app
        metrics_path: /metrics/executors/prometheus

      # Trino coordinator metrics (JMX exporter on port 9090)
      - job_name: 'trino-coordinator'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['{{ namespace }}']
        relabel_configs:
          # Match Trino coordinator pods
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: lakebench
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: trino-coordinator
          # Rewrite target to JMX exporter port
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: '${1}:9090'
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
        metrics_path: /metrics
        scrape_interval: 30s

      # Trino worker metrics
      - job_name: 'trino-worker'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['{{ namespace }}']
        relabel_configs:
          # Match Trino worker pods
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: lakebench
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: trino-worker
          # Rewrite target to JMX exporter port
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: '${1}:9090'
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
        metrics_path: /metrics
        scrape_interval: 30s
